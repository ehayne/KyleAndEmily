{% extends "wedding_base.html" %}

{% block wedding-content %}
<form name="people" id="people" method="POST" action="{% url "save" %}">
    {% csrf_token %}
    <input type="hidden" name="invitation_id" value="{{ invitation.id }}">

    <h3>{{ invitation.name }}</h3>

    <p>Hooray! We found your invitation. Please confirm your guest details below.</p>

    {% for person in invitation.people.all %}
    <h5 class="huge-margin-top">Guest #{{ forloop.counter }}</h5>

    <div class="row text-left">
        <div class="formInputs columns">
            <label class="label" for="person.{{ forloop.counter0 }}.attending">
                Attending?
            </label>
            <select class="attending" name="person.{{ forloop.counter0 }}.attending"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
        </div>

        <div class="formInputs columns">
            <label class="label" for="person.{{ forloop.counter0 }}.first_name">
                First Name
            </label>
            <input type="text" name="person.{{ forloop.counter0 }}.first_name" value="{{ person.first_name }}">

        </div>

        <div class="formInputs columns end">
            <label class="label" for="person.{{ forloop.counter0 }}.last_name">
                Last Name
            </label>
            <input type="text" name="person.{{ forloop.counter0 }}.last_name" value="{{ person.last_name }}">

        </div>
    </div>

    {% endfor %}
    {% if invitation.plusOne %}
    <h5 class="huge-margin-top">Plus One</h5>

    <div class="row text-left">
        <div class="formInputs columns">
            <label class="label" for="plus_one_attending">
                Attending?
            </label>
            <select class="attending" name="plus_one_attending"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
        </div>

        <div class="formInputs columns">
            <label class="label" for="plus_one_first_name">
                First Name
            </label>
            <input type="text" name="plus_one_first_name" value="">

        </div>

        <div class="formInputs columns end">
            <label class="label" for="plus_one_last_name">
                Last Name
            </label>
            <input type="text" name="plus_one_last_name" value="">

        </div>
    </div>
    {% endif %}

    <div class="formInputs row">

        <div class="medium-6 medium-offset-3 columns">
            <label class="label" for="song">
                Song Request:
            </label>
            <input type="text" name="song" value="{{ invitation.song }}" >
        </div>

        <div class="medium-6 medium-offset-3 columns">
            <label class="label" for="comment">
                Comment for the Couple:
            </label>
            <textarea name="comment">{{ invitation.comment }}</textarea>
        </div>

    </div>

    <button type="submit" class="huge-margin-top submit button">Save Guest Details</button>
</form>
<hr>
<form name="people" id="people" method="POST" action="{% url "save" %}">
    <table>
        <thead>
        <tr class="label">
          <td>First Name</td>
          <td>Last Name</td>
          <td>Attending?</td>
        </tr>
        </thead>
    <tbody>
    {% for person in invitation.people.all %}
        <tr class="formInputs">
          <td>
              <input type="text" name="person.{{ forloop.counter0 }}.first_name" value="{{ person.first_name }}">
          </td>
          <td>
              <input type="text" name="person.{{ forloop.counter0 }}.last_name" value="{{ person.last_name }}">
          </td>
          <td>
              <select class="attending" name="person.{{ forloop.counter0 }}.attending"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
        </tr>
    {% endfor %}

    {% if invitation.plusOne %}
        <tr class="formInputs">
          <td>
              <input type="text" name="plus_one_first_name" value="">
          </td>
          <td>
              <input type="text" name="plus_one_last_name" value="">
          </td>
          <td>
              <select class="attending" name="plus_one_attending"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
        </tr>
    {% endif %}
    </tbody>
    </table>


    <div class="formInputs row">

        <div class="medium-6 medium-offset-3 columns">
            <label class="label" for="song">
                Song Request:
            </label>
            <input type="text" name="song" value="{{ invitation.song }}" >
        </div>

        <div class="medium-6 medium-offset-3 columns">
            <label class="label" for="comment">
                Comment for the Couple:
            </label>
            <textarea name="comment">{{ invitation.comment }}</textarea>
        </div>

    </div>

    <button type="submit" class="huge-margin-top submit button">Save Guest Details</button>
</form>

{%  endblock %}

<script type="text/javascript">
    var $people_form = $("form#people"),
        $container = $("#container");

        $people_form.submit(function(event) {
            function show_error(msg) {
                var $error = $('<div data-alert class="alert-box alert radius">'+msg+'</div>');
                $people_form.append($error);
                $('html, body').animate({
                    scrollTop: $error.offset().top
                }, 500);
            }

            var $attending_missing = $("select option[value='-']:selected", $people_form);

            event.preventDefault();

            if ($attending_missing.length > 0) {
                show_error("Please indicate if all guests are going to be attending or not.");
                return;
            }

            $.ajax({
                url: '/save/',
                type: 'POST',
                data: $(this).serialize(),
                success: function(data, status, jqXHR) {
                    $people_form.fadeOut(function() {
                        $container.append(data);
                    });
                },
                error: function(jqXHR, status) {
                    show_error("Oops! We failed to save your response. Yell at Evan to fix this!");
                }
            });
    });
</script>