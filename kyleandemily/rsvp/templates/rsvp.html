{% extends "wedding_base.html" %}

{% block wedding-content %}

<form name="people" id="people" method="POST" action="{% url "save" %}">
{% csrf_token %}
<input type="hidden" name="invitation_id" value="{{ invitation.id }}">
    <table>
        <thead>
        <tr class="label">
          <td></td>
          <td>First Name</td>
          <td>Last Name</td>
          {% if invitation.helloGoodbyeInvite %}
            <td>Wedding</td>
            <td>Welcome Dinner</td>
            <td>Farewell Lunch</td>
          {%  else %}
            <td>Attending?</td>
          {% endif %}
        </tr>
        </thead>
    <tbody>
    {% for person in invitation.people.all %}
        <tr class="formInputs" data-value="{{ forloop.counter0 }}">
          <td class="editButtons">
            <p class="editButton buttons" id="editButton{{ forloop.counter0 }}">Edit</p>
            <p class="completeEditButton editable buttons" id="completeEdit{{ forloop.counter0 }}">Done</p>
          </td>
          <td class="firstName">
              <input class="editName{{ forloop.counter0 }} editable" type="text" name="person.{{ forloop.counter0 }}.first_name" value="{{ person.first_name }}">
              <p class="viewName{{ forloop.counter0 }}">{{ person.first_name }}</p>
          </td>
          <td class="lastName">
              <input class="editName{{ forloop.counter0 }} editable" type="text" name="person.{{ forloop.counter0 }}.last_name" value="{{ person.last_name }}">
              <p class="viewName{{ forloop.counter0 }}">{{ person.last_name }}</p>
          </td>
          <td class="rsvp">
              <select class="attendingWedding" name="person.{{ forloop.counter0 }}.attendingWedding"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
          {%  if invitation.helloGoodbyeInvite %}
            <td class="rsvp">
              <select class="attendingWedding" name="person.{{ forloop.counter0 }}.attendingWelcome"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
          <td class="rsvp">
              <select class="attendingWedding" name="person.{{ forloop.counter0 }}.attendingFarewell"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
          {% endif %}
        </tr>
    {% endfor %}

    {% if invitation.plusOne %}
        <tr class="formInputs" id="plusOne">
            <td></td>
            <td>Add Additional Guest</td>
            <td></td>
        {%  if invitation.helloGoodbyeInvite %}
            <td></td>
            <td></td>
        {%  endif %}
        </tr>
        <tr class="formInputs" id="plusOneEdit">
          <td></td>
          <td>
              <input type="text" name="plus_one_first_name" value="">
          </td>
          <td>
              <input type="text" name="plus_one_last_name" value="">
          </td>
          <td>
              <select class="attending" name="plus_one_attending"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
          {%  if invitation.helloGoodbyeInvite %}
          <td class="rsvp">
              <select class="attendingWedding" name="person.{{ forloop.counter0 }}.attendingWelcome"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
          <td class="rsvp">
              <select class="attendingWedding" name="person.{{ forloop.counter0 }}.attendingFarewell"><option selected="selected" value="-">&mdash;</option><option value="1">Yes</option><option value="0">No</option></select>
          </td>
          {% endif %}
        </tr>
    {% endif %}
    </tbody>
    </table>


    <div class="formInputs row">

        <div class="medium-6 medium-offset-3 columns" id="guestComment">
            <label class="label" for="comment">
                Comment for the Couple:
            </label>
            <textarea name="comment" id="commentText">{{ invitation.comment }}</textarea>
        </div>

    </div>

    <button type="submit" class="huge-margin-top submit button">Save Guest Details</button>
</form>

{%  endblock %}

<script type="text/javascript">
    var $people_form = $("form#people"),
        $container = $("#container");

        $people_form.submit(function(event) {
            function show_error(msg) {
                var $error = $('<div data-alert class="alert-box alert radius">'+msg+'</div>');
                $people_form.append($error);
                $('html, body').animate({
                    scrollTop: $error.offset().top
                }, 500);
            }

            var $attending_missing = $("select option[value='-']:selected", $people_form);

            event.preventDefault();

            if ($attending_missing.length > 0) {
                show_error("Please indicate if all guests are going to be attending or not.");
                return;
            }

            $.ajax({
                url: '/save/',
                type: 'POST',
                data: $(this).serialize(),
                success: function(data, status, jqXHR) {
                    $people_form.fadeOut(function() {
                        $container.append(data);
                    });
                },
                error: function(jqXHR, status) {
                    show_error("Oops! We failed to save your response. Yell at Emily to fix this!");
                }
            });
    });
</script>